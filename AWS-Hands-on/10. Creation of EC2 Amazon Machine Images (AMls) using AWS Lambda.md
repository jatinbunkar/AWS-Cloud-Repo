# Creation of EC2 Amazon Machine Images (AMls) using AWS Lambda

### Description

Creating and storing AMi's are essentials for any backup/disaster recovery plan. Automating the creation process allows for reliable backup planning. And by utilizing SNS in this process, we can inform an administrator when each image creation job has begun.

### Architecture Diagram

The diagram below displays a visual representation of the application architecture:

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab10-s1.png" alt="Screenshot of lab10-s1">
</p>

---

### Steps:

Follow the steps outlined below to achieve the objective of this lab exercise:

1. From the AWS Management Console dashboard, navigate to EC2.

2. Click Launch Instance.
3. Select an Amazon Linux AMl 2 (first in the list).
4. Select t2. micro from instance types list.

5. Click Review and Launch.
6. Click Launch.

7. Enter a key pair name, and click Download Key Pair.

8. Click Launch Instances.

9. Note the Instance Id of the instance that is getting created.

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab10-s2.png" alt="Screenshot of lab10-s2">
</p>

11. Navigate to Lambda Service and create a Lambda function. Specify a name to the function, with runtime as Python 3.8 and Role as CCL-Lambda-Role and create function.

Permissions

```python
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:CreateImage",
        "ec2:DescribeInstances",
        "ec2:DescribeImages",
        "ec2:DeleteSnapshot"
      ],
      "Resource": "*"
    }
  ]
}
```


12. Copy and paste the following code there - replacing INSTANCE_ID with the instance id you noted in Step 9
and save the function:

```python

import boto3
from datetime import datetime

# Create EC2 client
ec2 = boto3.client('ec2')

def lambda_handler(event, context):
    # Define the instance ID for which you want to create an AMI
    instance_id = 'i-093c22753bec8d7dd'
    
    # Generate a unique name for the AMI
    image_name = f'Lambda-Backup-{instance_id}-{datetime.now().strftime("%Y-%m-%d-%H-%M-%S")}'
    
    # Create the AMI
    try:
        response = ec2.create_image(
            InstanceId=instance_id,
            Name=image_name,
            NoReboot=True  # Set to True to avoid instance reboot during AMI creation
        )
        ami_id = response['ImageId']
        print(f'AMI created successfully with ID: {ami_id}')
        return {
            'statusCode': 200,
            'body': f'AMI created successfully with ID: {ami_id}'
        }
    
    except Exception as e:
        print(f'Error creating AMI: {e}')
        return {
            'statusCode': 500,
            'body': f'Error creating AMI: {e}'
        }
```

- Lambda Function

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab10-s3.png" alt="Screenshot of lab10-s3">
</p>

12. Navigate to SNS service and create an SNS Topic and specify a name to the Topic.

13. After creating the topic, open the topic you created and create the subscription for the topic.

14. Click on Create Subscription, select the protocol as Email, give your email address and create the subscription.

Note: You will receive a verification email from AWS to your email address. Click on that link and confirm your subscription.

15. Navigate to CloudWatch > Events > Rules.

16. Click on create rule, select Schedule, set the Rate as 1 Day and in targets select your SNS Topic and
Lambda Function you created in the previous steps.


