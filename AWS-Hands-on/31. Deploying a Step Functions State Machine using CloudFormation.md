# Deploying a Step Functions State Machine using CloudFormation

## 1.1 Description
In this use case, we will deploy a CloudFormation stack that creates a Step Functions state machine. This state machine will use a Lambda function as a state, and when the state machine is executed, it will return the current DateTime.

## 1.2 Architecture Diagram

## 1.3 Lab Steps

### Step 1: Navigate to CloudFormation Console
- Go to the **AWS CloudFormation Console** to create a new stack.

### Step 2: Create a New Stack
- Click on **Create Stack**.
- Select **Template is ready** option and click on **Upload a template file**.
- Save the CloudFormation template provided below and upload it to CloudFormation.
- Click **Next**.


policy
<img width="1006" alt="image" src="https://github.com/user-attachments/assets/712a006a-c8ca-40df-8699-eb3cdd12e4dd">


<img width="1440" alt="image" src="https://github.com/user-attachments/assets/1c4b695a-8f40-443b-80bf-b569e34f63dc">

<img width="1023" alt="image" src="https://github.com/user-attachments/assets/7fea9cb1-e65a-4713-a632-e91ce570434d">



### Step 3: Provide Stack Details
- Name the stack (e.g., `StepFunctionsStateMachineStack`).
- Leave all other settings as default.
- Do not select any IAM roles for the CloudFormation stack.
- Click **Next**.

### Step 4: Review and Create Stack
- Review the stack settings and click on **Create** to launch the stack.
- CloudFormation will now create the resources including the Step Functions state machine and Lambda function.

<img width="642" alt="image" src="https://github.com/user-attachments/assets/fce8fa79-2ec3-4942-95a5-cb4193f3a834">

### Step 5: Check Created Resources
- Once the stack creation is complete, navigate to the **Resources** tab (next to **Events**).
- Here, you will find the two resources that were created by the stack: the Lambda function and the State Machine.
- Click on the physical IDs of these resources to inspect them further.

<img width="960" alt="image" src="https://github.com/user-attachments/assets/4ba32492-91a1-47f5-97ae-ceb8d9710170">

<img width="987" alt="image" src="https://github.com/user-attachments/assets/041cd9d0-5376-4ea9-a005-bdcfe31e8534">

<img width="839" alt="image" src="https://github.com/user-attachments/assets/ec8e557e-a7a9-4095-b6cc-20976ff7fc43">

<img width="1321" alt="image" src="https://github.com/user-attachments/assets/f5cb79dc-8e23-4aa4-bc8f-117479e6eaf3">

<img width="835" alt="image" src="https://github.com/user-attachments/assets/7e4b3761-c4b0-4063-b8eb-faf509733bc6">

### Step 6: Access the State Machine
- Click on the **StateMachine**â€™s physical ID, which will take you to the newly created state machine in the **Step Functions Console**.
- On the State Machine page, click on **Start Execution** to test the state machine.
- Leave the input as default and click on **Start Execution** again.

### Step 7: Verify Execution
- Once the execution status shows as **Succeeded**, expand the **Output** section to view the result.
- The output will show the current DateTime returned by the Lambda function.

### Step 8: Modify the State Machine (Optional)
- You can modify the state machine by adding more states and integrating additional tasks such as invoking different Lambda functions or performing other AWS services' actions.

### Result:

<img width="1195" alt="image" src="https://github.com/user-attachments/assets/79719b31-6924-477d-8ee7-b8ed2a00bd0c">

###Task Completed

## File to be uploded in S3 bucket:

<img width="1155" alt="image" src="https://github.com/user-attachments/assets/64dbdca1-0dba-46a4-8e74-6db03ee111d1">

```bash
exports.handler = async (event) => {
    const datetime = new Date().toISOString();
    return {
        statusCode: 200,
        body: JSON.stringify({ message: "Current DateTime: " + datetime })
    };
};
```





## Example CloudFormation Template

```yaml
Resources:
  # Lambda Execution Role
  MyLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda Function
  MyLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: arn:aws:iam::502433561161:role/MyLambdaExecutionRole
      FunctionName: DateTimeLambdaFunction
      Runtime: nodejs18.x
      Code:
        S3Bucket: jatintests3bucket
        S3Key: node.zip

  # Step Functions Execution Role
  MyStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: StepFunctionsExecutionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt MyLambdaFunction.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"

  # Step Functions State Machine
  MyStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: DateTimeStateMachine
      RoleArn: !GetAtt MyStateMachineRole.Arn
      DefinitionString:
        Fn::Sub: |
          {
            "StartAt": "GetDateTime",
            "States": {
              "GetDateTime": {
                "Type": "Task",
                "Resource": "${MyLambdaFunction.Arn}",
                "End": true
              }
            }
          }
```




---



