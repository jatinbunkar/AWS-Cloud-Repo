# Creating AWS Lambda Function to Shutdown EC2 Instance

### Description

AWS Lambda is a compute service that lets you run code without provisioning or managing servers. AWS Lambda executes your code only when needed and scales automatically, from a few requests per day to thousands per second. You pay only for the compute time you consume - there is no charge when your code is not running. With AWS Lambda, you can run code for virtually any type of application or backend service - all with zero administration. AWS Lambda runs your code on a high-availability compute infrastructure and performs all of the administration of the compute resources, including server and operating system maintenance, capacity provisioning and automatic scaling, code monitoring and logging.
The objective of this lab is to create and customize python 3 based lambda function.

### Architecture Diagram

The diagram below displays a visual representation of the application architecture:

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab9-s1.png" alt="Screenshot of lab9-s1">
</p>
<br>

### Labs Steps

1. Create an EC2 instance and ensure that it is in a running state.

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab9-s2.png" alt="Screenshot of lab9-s2">
</p>

2. Navigate to Lambda in the AWS Console.
3. Click Create a function.
4. Make sure the Author from scratch option at the top is selected, and then use the following settings:
   a. Basic information:
   - Name: Name your function
   - Runtime: Python3.6
   
   b. Permissions:
   - Select Choose or create an execution role.
   - Execution role: Use an existing role
   - Existing role: CCL-Lambda Role

  - IAM Policy

```Powershell
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ec2:Start*",
        "ec2:Stop*"
      ],
      "Resource": "*"
    }
  ]
}

```

     
5. Click Create function.

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab9-s3.png" alt="Screenshot of lab9-s3">
</p>
---
** Lambda Function Created

<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab9-s4.png" alt="Screenshot of lab9-s4">
</p>
---

6. Type the following code in code section.
**Note: Make sure to change the instance-id with yours in the code given below:**

```yaml
import boto3

region = 'us-east-1'
instances = ['i-093c22753bec8d7dd']
ec2 = boto3.client('ec2', region_name=region)

def lambda_handler(event,context):
    ec2.stop_instances(InstanceIds=instances)
    print('stopped your instances: ' + str(instances))

```
<p align="center">
  <img src="https://github.com/jatinbunkar/AWS-Clouds/blob/03d73951c14bfb1fd3aa3735a3a2a7e37a5318d7/Screenshots/lab9-s5.png" alt="Screenshot of lab9-s5">
</p>

7. Verify that CloudWatch has captured Function Logs.
   
8. Navigate to CloudWatch and select Logs in the left-hand menu.

9. Select the log group with your function name in it.

10. Select the log stream within the log group.

11. Verify that the output is present and correct.

---

### Supporting References
Refer the below link for additional information:

- [AWS Documentation: start-stop-lambda-cloudwatch](https://aws.amazon.com/premiumsupport/knowledge-center/start-stop-lambda-cloudwatch/)
