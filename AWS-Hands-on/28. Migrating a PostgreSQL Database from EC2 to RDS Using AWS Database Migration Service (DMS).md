# **Migrating a PostgreSQL Database from EC2 to RDS Using AWS Database Migration Service (DMS)**


## 1. Set Up the Source Database on EC2

### 1.1 Launch an EC2 Instance
- Go to the EC2 Console and launch an instance (e.g., Amazon Linux or Ubuntu).
- Configure the security group to allow access on PostgreSQL’s default port 5432.
  - Example: `Inbound rule: TCP port 5432, source: your IP`.
 
<img width="1209" alt="image" src="https://github.com/user-attachments/assets/77d551da-6ea1-4316-86a9-80a0bcc94090">


### 1.2 Install PostgreSQL on EC2
- SSH into the EC2 instance.
- Install PostgreSQL:
  - **For Amazon Linux**: `sudo yum install postgresql -y`
  - **For Ubuntu**: `sudo apt update && sudo apt install postgresql -y`

### 1.3 Set Up PostgreSQL Database on EC2
- Start the PostgreSQL service (if it’s not already running).
- Switch to the PostgreSQL user:
  ```bash
  sudo -i -u postgres
  ```
- Create a new database and table:

```sql
psql
CREATE DATABASE sourcedb;
\c sourcedb
CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(50), position VARCHAR(50));
INSERT INTO employees (name, position) VALUES ('Alice', 'Developer'), ('Bob', 'Manager');
```
- Exit `psql` by typing ``\q`.

### 1.4 Allow External Connections to PostgreSQL:
- Edit the PostgreSQL config file at `/var/lib/pgsql/data/postgresql.conf` or `/etc/postgresql/XX/main/postgresql.conf`.
- Set `listen_addresses` to `'*'` to allow connections from any IP.
- Edit the `pg_hba.conf` file (located in the same directory) to add:

```text
host    all             all             0.0.0.0/0               md5
```

- Restart PostgreSQL:

```sql
sudo service postgresql restart
```
## 2. Configure the Target Database (RDS PostgreSQL)
1. Create a PostgreSQL RDS Instance:
    - Go to the RDS Console, select Create database.
    - Choose PostgreSQL, configure DB instance settings, and create the database.
    - Make sure it’s in the same VPC as the DMS replication instance.
2. Configure Security Group for RDS:
    - Add an inbound rule to the RDS security group allowing connections on port 5432 from the EC2 instance and DMS replication instance.
    - Retrieve the endpoint URL of the RDS instance; you’ll need this for DMS configuration.

##  3: Set Up AWS Database Migration Service (DMS)
1. Create a DMS Replication Instance:
    - In the DMS Console, select Create replication instance.
    - Ensure the instance is in the same VPC and has access to both the EC2 source and RDS target.

2. Configure Source and Target Endpoints:
    - Source Endpoint:
        - In DMS, go to Endpoints and select Create endpoint.
        - Set endpoint type as Source.
        - For database engine, select PostgreSQL.
        - Enter the EC2 PostgreSQL database’s endpoint details, including:
            - Endpoint identifier (e.g., source-ec2-db)
            - Server name (EC2 public or private IP, depending on setup)
            - Port: 5432
            - Database name: sourcedb
            - Username and password for PostgreSQL on EC2
        - Test Connection to confirm DMS can connect.
    - Target Endpoint:
        - Create another endpoint for the RDS target database.
        - Set endpoint type as Target.
        - Database engine: PostgreSQL.
        - Enter the RDS endpoint details, including:
            - Endpoint identifier (e.g., target-rds-db)
            - Server name (RDS endpoint URL)
            - Port: 5432
            - Database name: (your RDS database name)
            -Username and password for the RDS database
        - Test Connection to confirm DMS can connect to the RDS instance.

## 4: Create and Run the Migration Task
1. Create a Migration Task:
    - In DMS, go to Tasks and select Create task.
    - Enter a name for the task (e.g., ec2-to-rds-migration).
    - Choose the replication instance, source endpoint, and target endpoint created earlier.
    - Set the migration type (e.g., Migrate existing data only).
    - Select the schema and table(s) to migrate (e.g., public schema and employees table).
    - Enable logging if you need to troubleshoot errors.
2. Run the Migration Task:
    - Start the migration task. DMS will now begin migrating data from the EC2 PostgreSQL database to the RDS PostgreSQL database.
    - Monitor the task: In the DMS console, go to the Tasks section and monitor the task progress.
    - If the task completes successfully, it indicates the data has been migrated.

## 5: Verify Data in the RDS PostgreSQL Database
1. Connect to the RDS Instance:
- Use a PostgreSQL client such as `psql` from your local machine or EC2 instance:

```bash
psql -h <RDS-endpoint> -U <username> -d <database-name>
```

- When prompted, enter the password for the RDS database.

2. Verify Data:
- Once connected, verify that the data has been successfully migrated by querying the table:

```sql
SELECT * FROM employees;
```

- Check if all records from the EC2 PostgreSQL database are present in the RDS PostgreSQL database.

## 6: Cleanup Resources
- Stop or Terminate the DMS Replication Instance if it is no longer needed.
- Delete the EC2 Instance if it was only used for this lab.
- Optionally, keep the RDS instance if you plan to continue using it; otherwise, delete it to avoid costs.


