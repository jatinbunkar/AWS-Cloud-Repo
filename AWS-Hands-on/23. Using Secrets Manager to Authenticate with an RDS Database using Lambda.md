# Using Secrets Manager to Authenticate with an RDS Database using Lambda

## Description
In this hands-on lab, you will create an RDS instance and store its credentials in AWS Secrets Manager and you will try to access the RDS instance programmatically through AWS Lambda using the secrets stored in aws
secrets manager and finally you perform some SQL operations in it.

## Architecture Diagram
The diagram below displays a visual representation of the underlying application architecture:

<img width="717" alt="image" src="https://github.com/user-attachments/assets/60badbb1-e74a-41d7-9170-e3009964556d">

## Lab Steps

Prerequisites:
-  Sign into the AWS Management Console.
-  MySQL Workbench
-  AWS RDS
- AWS Lambda
- AWS Secrets Manager

Follow the steps outlined below to achieve the objectives of this lab exercise:
1. Create an RDS MySQL Instance
*  Go to Amazon RDS console.
*  In the navigation pane, choose Databases.
*  In the Databases page, choose Create Database
  -  Choose Standard create for Choose a database creation method.
  -  Choose MySQL in Engine options.
  -  Choose the version same as the version of the MySQL Workbench that you have downloaded in the pre-requisite section.
  -  Under Templates, choose Free tier.
  -  Under Settings,
      -  Choose a name for the DB instance in DB instance identifier.
      -  (Note: It will appear as DB name under Configuration after DB creation)
      -  In Credentials Settings, choose the Master username and Master Password (and Confirm Password as well) for the DB instance.
  -  In Storage, choose General Purpose SSD (gp3) and leave Allocated storage as 20 GiB.
  -  In Connectivity,
      -  Choose VPC as Default VPC (vpc-3af53251).
      -  For Subnet group, choose ccl_rds_subnet_group
      -  Change Public access to Yes.
      -  For VPC security group, leave it as default.
  -  Expand the Additional configuration (Below Database authentication),
      -  Specify a name for the Initial database name.
      -  Uncheck Enable automated backups.
(Note: Leave it checked if you want to restore the DB instance at any point)
  -  Choose Create database.
  -  Choose the db instance that you created, under Connectivity & security click on default (sg-620a4a06). (To allow MySQL workbench to connect to RDS instance)
      - Edit the Inbound rules and add a rule with Type (MYSQL/Aurora), Source (Anywhere-IPv4)
      - Choose Save rules


<img width="675" alt="image" src="https://github.com/user-attachments/assets/9583f7d0-b412-41fe-81c6-9f848f29a418">

<img width="614" alt="image" src="https://github.com/user-attachments/assets/6bd43c6d-0f74-474a-bd2c-21517d3a782d">

<img width="611" alt="image" src="https://github.com/user-attachments/assets/99465c01-1a56-4248-8667-c83c3c73f534">

<img width="610" alt="image" src="https://github.com/user-attachments/assets/5e2cd813-00f1-4b5e-a979-1872ab123e3b">

<img width="611" alt="image" src="https://github.com/user-attachments/assets/37a8487d-15e8-481e-983b-5397b2e566f8">

<img width="613" alt="image" src="https://github.com/user-attachments/assets/b1801404-ed2b-4282-9a39-66d7f1dd32f3">

<img width="614" alt="image" src="https://github.com/user-attachments/assets/c52ded7d-1f3f-4747-97ee-2a722a3c6014">

<img width="615" alt="image" src="https://github.com/user-attachments/assets/51fb7dfc-16f7-4b20-a313-37ef62b647a4">

<img width="1196" alt="image" src="https://github.com/user-attachments/assets/86a4218d-6003-42e1-8978-c53ec8709c2d">

Database Created

<img width="1201" alt="image" src="https://github.com/user-attachments/assets/2fb69df6-fb13-4016-a16e-0cdd4f770493">

<img width="1169" alt="image" src="https://github.com/user-attachments/assets/6a1cb96d-9055-4414-9ad7-a4028ebeb6e0">

2. Connecting to the Database using MySQL Workbench and creating table and records in it
  -  Open the MySQL Workbench.
  -  Choose Create a New DB Connection.
    -  Specify the Connection Name. (Ex: my-rds-connection, choose any valid name for this.)
    -  Specify the Host name (Note: The host name is the Endpoint under Connectivity & security in the RDS instance, It will appear only after the RDS instance is created and running! )
  -  Specify the Username and Password.
  - Choose Ok.


<img width="1440" alt="image" src="https://github.com/user-attachments/assets/9ef00aab-5ece-4a35-8dda-0e4332386ec3">

<img width="1440" alt="image" src="https://github.com/user-attachments/assets/f7a892af-7e7e-40fc-b821-d76a16319eca">

<img width="809" alt="image" src="https://github.com/user-attachments/assets/8c9883ff-c372-44de-bb77-17f957e1939b">

Connected

<img width="1440" alt="image" src="https://github.com/user-attachments/assets/a9825cb7-5b21-4350-a80a-cdbe8efdc04d">

  -  Choose the connection that you created under Connections.
    -  In Query editor, Use the following query to create a table in the database,

```sql
use <initial-database-name>;
create table User (
username varchar(100) not null,
alias varchar(100) not null,
address varchar(100) not null,
designation varchar(100) not null,
primary key (username, address, designation)
);
```
(Note: Substitute the initial database name from 1.3 (viii) in the <initial-database-name>)

<img width="653" alt="image" src="https://github.com/user-attachments/assets/9ef88bbf-df69-4f6c-9445-eddfa762f8aa">

<img width="1003" alt="image" src="https://github.com/user-attachments/assets/bb569736-9530-47ff-9329-6b9f829bf09e">

  - In Query editor, Use the following query to insert a record into the table.

```sql
insert into User (username, alias, address, designation) values
('John', 'Three', 'United Kingdom', 'Intern');
```

<img width="632" alt="image" src="https://github.com/user-attachments/assets/0331d74c-be14-44b4-bf55-9d38d5147ea6">

<img width="1006" alt="image" src="https://github.com/user-attachments/assets/2a344f82-06dd-4e57-a903-cc2d39062259">


3. Storing DB Credentials in Amazon Secrets Manager
  -  Go to AWS Secrets Manager console.
  -  In the navigation pane, choose Secrets.
  -  In the Secrets page, choose Store a new secret,
      -  Choose Credentials for Amazon RDS database as Secret type.
      -  Under Credentials, specify the Username and Password that you used while creating the RDS DB instance in step 1.3 (v) (b).
      -  Leave the Encryption key as DefaultEncryptionKey.
      -  Under Database, choose the Database instance you created earlier and choose Next.
      -  Under Secret name and description, specify a name for the Secret name and provide Description (Optional) and choose Next.
      -  Under Secret rotation, choose Disable automatic rotation and choose Next.
      -  Review the secret settings and choose Store.

<img width="1331" alt="image" src="https://github.com/user-attachments/assets/45753e08-9847-4351-a969-ef976fe65109">

<img width="858" alt="image" src="https://github.com/user-attachments/assets/2782440b-4c3b-4d65-a45b-7f31a0ad3135">

<img width="625" alt="image" src="https://github.com/user-attachments/assets/f61d6cbd-6390-4c78-80ab-a1a623d65564">

<img width="830" alt="image" src="https://github.com/user-attachments/assets/472022f1-423f-4863-be71-6967199b338a">

<img width="1376" alt="image" src="https://github.com/user-attachments/assets/8f96d308-93bd-441c-94df-3d39326bb078">

4. Using Lambda to Connect to RDS using the Secrets stored in AWS Secrets Manager

  -  Go to Amazon Lambda console.
  -  In the navigation pane, choose Layers under Additional resources,
      -  In the Layers page, choose Create layer.
          -  Specify a unique name for the Layer.
          -  Choose Upload a file from Amazon S3 and paste the following URL there,

LAYER Created

<img width="1358" alt="image" src="https://github.com/user-attachments/assets/23ae7cf3-8df5-427a-9f28-faa0b0043310">

Function Created

<img width="627" alt="image" src="https://github.com/user-attachments/assets/7af318d6-0603-4d2e-be31-7d3ffe8e4999">

Add IAM ROLE:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret"
            ],
            "Resource": "arn:aws:secretsmanager:us-east-1:502433561161:secret:test/jatinrdsdatabase-u17ScO"
        },
        {
            "Effect": "Allow",
            "Action": [
                "rds:DescribeDBInstances"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        }
    ]
}
```

Add Code to the Lambda:

```python

import json
import pymysql  # Use 'pymysql' instead of 'python' as an import
import boto3
from typing import Any, Dict

# Getting secret from Secrets Manager
secret_name = "test/jatinrdsdatabase"  # Replace with your actual secret name
region_name = "us-east-1"

# Initializing Secrets Manager client
session = boto3.session.Session()
client = session.client(
    service_name='secretsmanager',
    region_name=region_name
)

# Function to get database credentials from Secrets Manager
def get_db_credentials(secret_name: str) -> Dict[str, Any]:
    get_secret_value_response = client.get_secret_value(SecretId=secret_name)
    return json.loads(get_secret_value_response["SecretString"])

# Retrieve the database credentials
credentials = get_db_credentials(secret_name)
username = credentials["username"]
password = credentials["password"]
host = credentials["host"]
port = credentials["port"]
db = credentials["dbname"]

# Connection with RDS DB instance
conn = pymysql.connect(
    host=host,
    user=username,
    password=password,
    database=db,
    cursorclass=pymysql.cursors.DictCursor
)

def lambda_handler(event: Any, context: Any) -> None:
    # Executing a query
    with conn.cursor() as cur:
        qry = "SELECT * FROM User"  # Ensure the table name matches your database
        cur.execute(qry)
        body = cur.fetchall()

        # Debug output to show how many rows were retrieved
        print(f"Retrieved {len(body)} rows from the User table.")

        # Print each item retrieved from the database
        for item in body:
            print(item)

```

<img width="1229" alt="image" src="https://github.com/user-attachments/assets/baaa6f72-c3fe-43ca-9197-55e7342dfafa">


<img width="1237" alt="image" src="https://github.com/user-attachments/assets/a7f79e05-446c-4cb6-b7c6-1366b11f91ba">

Download python files and upload to the lambda:

<img width="269" alt="image" src="https://github.com/user-attachments/assets/3dc23380-52ec-43fb-ac94-87137a988320">


Lambda Ran

<img width="1218" alt="image" src="https://github.com/user-attachments/assets/4bdf0e00-685f-4680-985f-5b947bab5d01">

Log output


```python
START RequestId: 5ac66cfc-8060-42b4-bfe6-82cc428586a6 Version: $LATEST
{'username': 'Jatin Bunkar', 'alias': 'One', 'address': 'India', 'designation': 'Tech Lead'}
END RequestId: 5ac66cfc-8060-42b4-bfe6-82cc428586a6
REPORT RequestId: 5ac66cfc-8060-42b4-bfe6-82cc428586a6	Duration: 2.13 ms	Billed Duration: 3 ms	Memory Size: 128 MB	Max Memory Used: 80 MB
```


Cloud Watch Log:

<img width="772" alt="image" src="https://github.com/user-attachments/assets/b24763a1-4078-4fe5-9a86-14feb7ee496e">
